<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secret Agent Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style-dashboard.css') }}">
</head>
<body>
  <header>
    <h2>Welcome Agent {{ username }}</h2>
    <a class="logout" href="/logout">Logout</a>
  </header>

  <div class="container">
    <div class="main-content">
      <h3>Global Threat Map</h3>
      <video autoplay muted loop style="width: 100%; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
        <source src="{{ url_for('static', filename='threatmap.mp4') }}" type="video/mp4">
        Your browser does not support HTML5 video.
      </video>
    </div>

    <div class="communications">
      <h3>Communications</h3>

      {% if role == "superior_officer" %}
        <form id="search-form">
          <label for="q">Search Subject:</label><br>
          <input name="q" id="search-input" value="{{ q }}" />
          <button type="submit">Search</button>
        </form>
      {% endif %}
        <div id="loader" style="display:none;">
          <div class="spinner"></div>
        </div>

      <div class="table-wrapper" id="results-container">
        {% if q and results %}
          <table>
            <thead>
              <tr><th>Subject</th><th>Content</th></tr>
            </thead>
            <tbody>
              {% for row in results %}
              <tr>
                <td>
                  <div class="preview" onclick="toggleContent(this)" title="Click to expand">
                    {{ row['subject'] }}
                  </div>
                </td>
                <td>
                  <div class="preview" onclick="toggleContent(this)" title="Click to expand">
                    {{ row['content'] }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if page > 1 %}
              <a href="{{ url_for('dashboard', q=q, page=page-1) }}" class="pagination-link">← Prev</a>
            {% endif %}
            <span>Page {{ page }} of {{ total_pages }}</span>
            {% if page < total_pages %}
              <a href="{{ url_for('dashboard', q=q, page=page+1) }}" class="pagination-link">Next →</a>
            {% endif %}
          </div>
        {% elif q %}
          <p style="color:#e67e22;">⚠️ No results found for "{{ q }}"</p>
        {% else %}
          <table>
            <thead>
              <tr><th>Subject</th><th>Content</th></tr>
            </thead>
            <tbody>
              {% for row in results %}
              <tr>
                <td>
                  <div class="preview" onclick="toggleContent(this)" title="Click to expand">
                    {{ row['subject'] }}
                  </div>
                </td>
                <td>
                  <div class="preview" onclick="toggleContent(this)" title="Click to expand">
                    {{ row['content'] }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if page > 1 %}
              <a href="{{ url_for('dashboard', q=q, page=page-1) }}" class="pagination-link">← Prev</a>
            {% endif %}
            <span>Page {{ page }} of {{ total_pages }}</span>
            {% if page < total_pages %}
              <a href="{{ url_for('dashboard', q=q, page=page+1) }}" class="pagination-link">Next →</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
<script>
document.getElementById("search-form").addEventListener("submit", function(e) {
  e.preventDefault();

  const query = document.getElementById("search-input").value;
  const loader = document.getElementById("loader");
  const resultsContainer = document.getElementById("results-container");

  loader.style.display = "block";
  resultsContainer.style.opacity = "0.5";

  fetch(`/dashboard?q=${query}`, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
  .then(response => response.text())
  .then(html => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const newTable = doc.querySelector("#results-container").innerHTML;

    resultsContainer.innerHTML = newTable;
  })
  .catch(err => {
    resultsContainer.innerHTML = `<p style="color:red;">Error during the search.</p>`;
    console.error("Error AJAX:", err);
  })
  .finally(() => {
    loader.style.display = "none";
    resultsContainer.style.opacity = "1";
  });
});
</script>
<script>
document.addEventListener("click", function(e) {
  const target = e.target.closest(".pagination-link");
  if (!target) return;

  e.preventDefault();

  const url = target.getAttribute("href");
  const loader = document.getElementById("loader");
  if (loader) loader.style.display = "block";
  const resultsContainer = document.getElementById("results-container");

  loader.style.display = "block";
  resultsContainer.style.opacity = "0.5";

  fetch(url, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
  .then(response => response.text())
  .then(html => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const newTable = doc.querySelector("#results-container").innerHTML;
    resultsContainer.innerHTML = newTable;
  })
  .catch(err => {
    resultsContainer.innerHTML = `<p style="color:red;">Error loading page.</p>`;
    console.error("Pagination AJAX error:", err);
  })
  .finally(() => {
    if (loader) loader.style.display = "none";
    resultsContainer.style.opacity = "1";
  });
});
</script>
<script>
  function toggleContent(el) {
    el.classList.toggle("expanded");
  }
</script>
</body>
</html>
