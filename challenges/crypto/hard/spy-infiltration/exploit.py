from time import sleep
from base64 import b64decode
from string import printable as printable_chars
import requests
import sys

if len(sys.argv) < 2:
    print(f"Usage: python3 {sys.argv[0]} host:port")
    sys.exit(1)

url = sys.argv[1]


def get_encrypted_message(user_input: str) -> str:
    payload = {
        "comment": user_input,
        "baud_rate": "9600",
        "timezone": "UTC",
        "mode": "default",
    }
    resp = requests.post(f"{url}/config", json=payload)
    resp.raise_for_status()
    resp = requests.get(f"{url}/config/download")
    resp.raise_for_status()
    return resp.json().get("encrypted_config", "")


def get_blocks(msg: str) -> list[str]:
    b = b64decode(msg).hex()
    blocks: list[str] = []
    while len(b) > 32:
        blocks.append(b[:32])
        b = b[32:]
    return blocks


def find_block_size():
    user_input = "a" * 31
    for _ in range(0, 15):
        user_input += "a"
        msg = get_encrypted_message(user_input)
        b = get_blocks(msg)
        if b[2] == b[3]:
            print(f"Found matching blocks at input length {len(user_input)}")
            return len(user_input)

    raise ValueError("Block size not found")


def check_flag(buffer: str):
    if ":" not in buffer:
        return
    len_str = buffer.split(":")[0]
    len_int = int(len_str)
    if len(buffer) == len(len_str) + 2 + len_int:
        flag = buffer[:-1][-len_int:]
        print(f"\nFound flag: {flag}")
        exit(0)


def solution():
    size = find_block_size()
    padding = "a" * (size % 16)
    known_buffer = "a" * 15
    alignment_buffer = "a" * 15
    scan_block = 3

    while True:
        check_flag(known_buffer[16:])
        for c in printable_chars:
            user_controlled_input = padding + known_buffer[-15:] + c + alignment_buffer
            print(f"\rTesting character: {known_buffer[15:]}{c}", end="")
            msg = get_encrypted_message(user_controlled_input)
            sleep(0.005)
            b = get_blocks(msg)
            if b[2] == b[scan_block]:
                known_buffer += c
                if alignment_buffer == "":
                    alignment_buffer = "a" * 15
                    scan_block += 1
                else:
                    alignment_buffer = alignment_buffer[1:]
                break
        else:
            print("No more matching character found, exiting")
            break


if __name__ == "__main__":
    solution()
